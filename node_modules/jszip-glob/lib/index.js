"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.zipFiles = void 0;
const fs_1 = require("fs");
const path_1 = require("path");
const glob = require("glob");
const { readFile, stat } = fs_1.promises;
/**
 * Zip files that are matched by the pattern.
 */
async function zipFiles(pattern, options) {
    const files = await new Promise((resolve, reject) => {
        glob(pattern, options, (err, files) => {
            if (err) {
                return reject(err);
            }
            resolve(files);
        });
    });
    await Promise.all(files.map(f => zipFile(f, options)));
    return options.zip;
}
exports.zipFiles = zipFiles;
async function zipFile(name, options) {
    const { cwd, zip, compression, compressionOptions, } = options;
    const file = path_1.join(cwd, name);
    const stats = await stat(file);
    const data = await readFile(file);
    zip.file(name, data, {
        mode: stats.mode,
        date: new Date(stats.mtime),
        compression,
        compressionOptions,
    });
}
